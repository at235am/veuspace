import getStroke, { StrokeOptions } from "perfect-freehand";
import {
  colorToNumber as ctn,
  getRandomIntInclusive,
  getSvgPathFromStroke,
} from "../../utils/utils";
import { MultiPolygon, Ring, union } from "polygon-clipping";
import {
  BaseRenderTexture,
  Graphics,
  InteractionEvent,
  InteractionManagerOptions,
  Rectangle,
  RenderTexture,
  Texture,
} from "pixi.js-legacy";

import { PixiApplication } from "../PixiApplication";
import { BaseTool } from "./BaseTool";
import { Path, SVGPathNode, SVGScene } from "@pixi-essentials/svg";
import debounce from "lodash.debounce";

export type FreehandToolOptions = {
  color: number | string;
};

const DEFAULT_STROKE_OPTIONS: StrokeOptions = {
  size: 10,
  smoothing: 0.5,
  thinning: 0.7,
  streamline: 0.99,
  easing: (t) => t,
  start: {
    taper: 0,
    cap: true,
  },
  end: {
    taper: 0,
    cap: true,
  },
};

const STR =
  "M 155.1591575370646 93.82056781300986 Q 155.1591575370646 93.82056781300986 157.5437592384921 92.28464401144066 159.9283609399196 90.74872020987145 166.86270667708067 85.92417770483732 173.79705241424176 81.0996351998032 180.59776492400073 76.02840021846546 187.39847743375972 70.95716523712773 194.63897744038286 64.84484069069913 201.87947744700602 58.73251614427055 217.51200989785164 56.79953011070097 233.14454234869726 54.866544077131394 237.24575358265798 63.0925871392188 241.34696481661868 71.3186302013062 239.56839813760791 79.56746556909962 237.78983145859712 87.81630093689303 239.25208734590547 96.03858528890075 240.7143432332138 104.26086964090848 236.9844664235468 115.9129543822004 233.2545896138798 127.56503912349231 236.87211282656557 134.70045434442395 240.48963603925134 141.83586956535558 240.62156558443985 150.04836932452787 240.7534951296284 158.2608690837002 240.86613018743392 166.2608693244585 240.97876524523946 174.26086956521684 241.0768722496956 182.2608695652171 241.17497925415176 190.26086956521738 241.26043208502526 198.26086956521738 241.34588491589875 206.26086956521738 242.40564287428697 214.7578269355542 243.46540083267521 223.25478430589104 241.67474299592396 232.44413842584544 239.88408515917268 241.6334925457998 232.16574487362124 249.29496098638234 224.44740458806982 256.95642942696486 216.0933363951329 257.32955423982594 207.73926820219597 257.7026790526871 199.25551201387674 257.754132496829 190.77175582555753 257.8055859409709 179.17250330533807 256.0773795641418 167.5732507851186 254.34917318731266 159.6586988026055 255.66384628205742 151.7441468200924 256.9785193768022 141.34899512889527 252.8057934742484 130.95384343769814 248.63306757169457 129.34648635128957 252.35615380960775 127.73912926488097 256.07924004752095 124.97743126508044 255.74389828065264 122.21573326527992 255.40855651378433 119.61454531652655 254.42202156865125 117.01335736777317 253.43548662351813 114.72386063586478 251.85509595748348 112.4343639039564 250.27470529144884 110.58962404652306 248.19231128427697 108.74488418908972 246.10991727710507 107.45211757332018 243.6465487663336 106.15935095755064 241.18318025556215 105.49369323989382 238.48200833477804 104.828035522237 235.78083641399394 104.82817476051889 232.99885332214717 104.82831399880078 230.2168702303004 105.4942421004859 227.51576495540002 106.16017020217103 224.81465968049966 107.45318339470094 222.35142058803376 108.74619658723086 219.8881814955679 110.59114488310377 217.8059721573254 112.43609317897668 215.7237628190829 114.72574809655191 214.14360133963464 117.01540301412714 212.5634398601864 119.61668970201627 211.5771652989615 122.2179763899054 210.59089073773657 124.97970794358736 210.2558254185733 127.74143949726933 209.92076009941002 139.1437387586319 211.67967404587745 150.54603801999448 213.43858799234485 160.04203440470724 213.95212254254864 169.53803078942002 214.4656570927524 177.90923226344134 214.2791237802254 186.28043373746266 214.09259046769841 198.42636582767875 215.4035119606798 210.57229791789482 216.71443345366114 221.54623199798834 217.5684894332881 232.52016607808184 218.42254541291504 240.6532881458228 218.72706650517793 248.78641021356378 219.03158759744082 257.31028186156175 221.00526067390345 265.83415350955977 222.97893375036608 276.20279380325576 225.96727610671167 286.57143409695175 228.95561846305722 295.59694830993203 231.37394655986714 304.6224625229124 233.79227465667705 313.139004122996 236.10997282318013 321.6555457230797 238.4276709896832 329.9582076882239 240.7088354513546 338.26086965336816 242.98999991302597 338.2608696527798 242.99499991302596 338.26086965219145 242.99999991302596 338.2608696516031 243.00499991302596 338.26086965101473 243.00999991302595 332.7595512777485 244.287631126976 327.2582329044823 245.5652623409261 319.25940157996286 246.96787279283072 311.2605702554434 248.37048324473534 303.26068005753643 249.75078968992258 295.2607898596295 251.13109613510983 287.26005388233693 252.5216229813434 279.2593179050444 253.912149827577 271.2553434079157 255.7657048761787 263.251368910787 257.6192599247804 255.1979274439728 259.48460949008336 247.1444859771586 261.34995905538625 238.7268895684037 262.27301313666976 230.30929315964875 263.1960672179533 222.1217465287535 262.69376965292975 213.93419989785826 262.1914720879062 204.63129398079454 261.6948392841078 195.3283880637308 261.19820648030935 186.93335622300694 260.68737774016665 178.53832438228307 260.1765490000239 169.86215305487818 259.597816319188 161.1859817274733 259.0190836383521 152.63120771150233 258.0732043673144 144.0764336955314 257.12732509627676 135.90893544220586 256.60328251425847 127.7414371888803 256.07923993224017 124.97970566871163 255.7441743368481 122.21797414854296 255.409108741456 119.61668755930118 254.42283392005004 117.0154009700594 253.43655909864404 114.72574621053215 251.85639739018416 112.43609145100491 250.27623568172427 110.5911433633949 248.19402615894978 108.7461952757849 246.11181663617532 107.45318232962853 243.64857741438206 106.16016938347217 241.1853381925888 105.494241551952 238.48423285108223 104.82831372043184 235.78312750957565 104.82817476040431 233.00114441771495 104.82803580037678 230.2191613258543 105.49369378820523 227.51798947164937 106.15935177603367 224.81681761744446 107.45211863818969 222.35344923597575 108.7448855003457 219.890080854507 110.58962556606039 217.80768703184629 112.43436563177508 215.72529320918554 114.72386252175437 214.14490277214674 117.01335941173365 212.5645123351079 119.61454745916038 211.577977650146 122.21573550658712 210.59144296518411 124.97743353992857 210.25610147454125 127.73913157327001 209.9207599838984 131.2392256878277 209.93386528531107 134.7393198023854 209.94697058672378 142.74029111632132 210.4819846204043 150.74126243025722 211.0169986540848 158.99183397121547 211.04690617303092 167.24240551217372 211.07681369197704 175.99086410355773 211.61806661318593 184.73932269494176 212.15931953439485 192.73922638036464 212.204945643009 200.7391300657875 212.25057175162314 208.7741215806265 212.32404563859757 216.8091130954655 212.39751952557197 210.79579026454013 218.49929149501196 204.78246743361473 224.60106346445193 200.713332170606 215.93096651483467 196.64419690759726 207.26086956521738 196.72891537820544 199.26086956521738 196.8136338488136 191.26086956521738 196.9108977462002 183.26086956521726 197.00816164358682 175.26086956521715 197.1198287423814 167.26086946289485 197.23149584117596 159.26086936057257 197.36083396525765 151.17055696286113 197.49017208933938 143.08024456514968 197.64270837117922 134.67052015811439 197.79524465301907 126.26079575107909 198.4701583902179 118.26083265790102 199.14507212741674 110.26086956472295 199.34092579671065 102.2606552649438 199.53677946600456 94.26044096516463 200.26573314718672 86.24651244201283 200.99468682836888 78.23258391886101 202.58893859109173 69.92313722183547 204.1831903538146 61.61369052480995 206.99451485176277 70.59409736100356 209.80583934971094 79.57450419719719 222.18740060822228 79.83718741867888 234.56896186673362 80.09987064016057 227.2600479347056 85.90355095018526 219.9511340026776 91.70723126020997 213.17846774390745 96.5223519882143 206.4058014851373 101.33747271621861 198.09015453448973 105.55239754120802 189.7745075838422 109.76732236619743 183.31057332196127 114.63430107816299 176.84663906008038 119.50127979012855 174.3437407615079 120.84035598855934 171.8408424629354 122.17943218699014 170.02291685594844 122.9714831460689 168.2049912489615 123.76353410514767 166.25033848574822 124.09749639280761 164.2956857225349 124.43145868046756 162.31791031353217 124.28792239285872 160.34013490452944 124.14438610524988 158.4541852494339 123.5316935781521 156.56823559433835 122.91900105105434 154.8837231757151 121.8727620029298 153.19921075709186 120.82652295480527 151.8140395158578 119.4075448482883 150.4288682746237 117.98856674177132 149.42354442840133 116.27932065108307 148.41822058217895 114.57007456039481 147.85117360014561 112.66990194863467 147.28412661811228 110.76972933687455 147.1883132975064 108.78906832551725 147.09249997690048 106.80840731415995 147.4734889924174 104.86237401424654 147.85447800793432 102.91634071433312 148.69012626009152 101.11803867268853 149.5257745122487 99.31973663104395 150.76751408536802 97.77368324682145 152.00925365848735 96.22762986259895 153.58491459023625 95.02368183113053 155.16057552198515 93.81973379966212 155.1598665295249 93.82015080633599 Z";

const STR2 =
  "M 136.6832207305832 72.1177847553749 Q 136.6832207305832 72.1177847553749 137.8835865985817 70.05439660989688 139.08395246658017 67.99100846441887 145.0930035493865 61.989909316457606 151.10205463219285 55.98881016849634 158.72824722157753 51.85398823833732 166.35443981096222 47.719166308178295 174.76295008549766 44.68193681217339 183.1714603600331 41.64470731616848 191.53927313152997 40.23992555917972 199.90708590302683 38.835143802190956 208.0839775315941 38.5481729602938 216.26086916016132 38.26120211839664 226.15543345852825 39.684351637192925 236.0499977568952 41.10750115598921 246.34623381666367 45.283703310077364 256.64246987643213 49.459905464165516 263.6382506629317 54.588137641267025 270.6340314494312 59.716369818368534 274.7243597884286 67.1954530650741 278.81468812742605 74.67453631177968 280.0878813723873 82.96498159653777 281.3610746173485 91.25542688129586 279.8030678918334 103.53171351112005 278.24506116631824 115.80800014094423 275.4606528433886 124.56660604280432 272.6762445204589 133.32521194466443 266.81385020991803 143.6242246368941 260.95145589937715 153.92323732912376 256.5434829380562 162.0061265589102 252.13550997673516 170.08901578869666 246.80677499793944 177.07532955862968 241.47804001914375 184.06164332856267 234.0804069831857 191.6562476240511 226.68277394722762 199.25085191953954 220.41003714823222 205.19091267141465 214.13730034923685 211.13097342328976 206.89967182780214 217.8657576677411 199.66204330636742 224.60054191219245 193.47467298535867 229.72336319612532 187.28730266434994 234.84618448005818 179.0609620800469 239.6257167999594 170.83462149574385 244.40524911986063 163.76899225747593 248.21435610118834 156.70336301920798 252.02346308251606 153.49973805674415 253.34596151021816 150.29611309428034 254.66845993792023 147.58235645371406 255.26592946251515 144.86859981314774 255.86339898711003 142.0907167257728 255.79404129169149 139.31283363839788 255.72468359627294 136.63227479977087 254.99252975335745 133.95171596114383 254.26037591044195 131.52427557691124 252.90797873577986 129.09683519267864 251.55558156111775 127.06359621202483 249.6615424420425 125.03035723137104 247.7675033229673 123.50949159938298 245.4419039020706 121.98862596739491 243.11630448117393 121.0685264660613 240.49430870606614 120.14842696472769 237.87231293095837 119.88256982029674 235.10631131928272 119.61671267586577 232.34030970760705 120.02054951806302 229.5910624029941 120.42438636026027 226.84181509838115 121.47444617284305 224.26910848334785 122.52450598542582 221.69640186831458 124.15975924274994 219.4497617722048 125.79501250007408 217.20312167609504 127.92041820599185 215.41312292685257 130.04582391190962 213.62312417761012 132.53785338693132 212.3938015866437 135.02988286195304 211.16447899567726 143.246356895256 208.16039433428455 151.462830928559 205.15630967289187 159.89128205112542 202.14388044158412 168.31973317369187 199.13145121027637 176.55894391216776 197.18464540526048 184.79815465064365 195.23783960024457 193.45884444426065 193.5590821653406 202.11953423787767 191.88032473043668 210.40553175628543 191.1130527232058 218.69152927469318 190.34578071597494 226.97159283441954 191.76035451736027 235.25165639414587 193.17492831874557 243.25318549886498 195.02430963633122 251.25471460358412 196.87369095391688 259.10583986590035 199.18393311970607 266.9569651282166 201.49417528549523 275.19463262425444 204.31519827696437 283.43230012029227 207.1362212684335 291.46491134314806 211.06413763244336 299.49752256600385 214.99205399645325 306.59602734784545 219.76121253584756 313.69453212968705 224.5303710752419 313.6903900949609 224.53317170880007 313.6862480602347 224.53597234235826 313.68210602550846 224.53877297591646 313.6779639907823 224.54157360947463 308.98234049828704 223.74555479213956 304.28671700579184 222.94953597480452 295.4294399777227 222.73568425023163 286.57216294965366 222.52183252565874 278.2861450778788 223.1629106202879 270.00012720610397 223.80398871491707 261.91744253549604 225.16679320108256 253.8347578648881 226.529597687248 245.62236482424595 228.42610660218867 237.40997178360382 230.3226155171293 229.55778065520192 232.1455688689565 221.70558952680003 233.9685222207837 210.58855253777085 235.81214710890646 199.47151554874165 237.65577199702923 190.0157883148377 238.4392093529882 180.56006108093374 239.22264670894717 172.68241275360901 241.90487611840683 164.80476442628432 244.58710552786647 157.55152632163578 249.6274009683792 150.29828821698723 254.6676964088919 147.58459133694208 255.26543730616305 144.8708944568969 255.8631782034342 142.09300444764187 255.7940982966707 139.31511443838684 255.72501838990723 136.63448239777844 254.99313260653594 133.95385035717004 254.26124682316464 131.5262747453574 252.90909239930255 129.09869913354476 251.55693797544043 127.06527075914556 249.66310218973314 125.03184238474637 247.7692664040258 123.51074420042093 245.4438190813201 121.9896460160955 243.11837175861436 121.06928431978531 240.49646800656654 120.14892262347513 237.8745642545187 119.88278888021274 235.10858924238744 119.61665513695036 232.34261423025617 120.02021705239842 229.59332655570532 120.42377896784649 226.84403888115446 121.47358150451788 224.27122727300363 122.52338404118929 221.6984156648528 124.15841262632793 219.45161205465075 125.79344121146656 217.2048084444487 127.91866790688267 215.414597163586 130.0438946022988 213.62438588272332 132.53580113260148 212.39481409495642 135.02770766290413 211.16524230718952 131.25488325692896 214.52480348007924 127.4820588509538 217.88436465296894 135.39671052080823 214.62561729974135 143.31136219066266 211.36686994651376 150.9933861812873 207.12728719758968 158.67541017191192 202.88770444866563 164.98774126570243 196.77980556527163 171.3000723594929 190.67190668187763 177.74925960869626 185.85224915251231 184.19844685789965 181.032591623147 190.89390653015562 174.65261687589106 197.58936620241155 168.27264212863508 203.3270972335859 161.0829450675064 209.06482826476028 153.89324800637766 214.61738361329805 147.12244769973526 220.1699389618358 140.35164739309286 224.72996806109927 132.49997773651086 229.2899971603627 124.64830807992882 232.89412895685496 116.79858594080892 236.4982607533472 108.948863801689 240.77593314343403 101.47210553948375 245.05360553352085 93.9953472772785 240.14472220259395 87.4550138906572 235.23583887166706 80.91468050403591 226.7483542579531 79.35892314534685 218.26086964423914 77.80316578665779 210.65410877268124 74.80041154575211 203.04734790112335 71.79765730484644 192.79801348605224 75.30064838138951 182.54867907098117 78.80363945793258 174.8198633022005 82.38131549675686 167.09104753341984 85.95899153558112 165.70391340141833 87.92060339010311 164.3167792694168 89.8822152446251 163.05316151389266 91.40649400459155 161.78954375836852 92.930772764558 160.19785159600772 94.1083429877039 158.60615943364692 95.28591321084983 156.7789020877112 96.04833446047806 154.95164474177548 96.81075571010629 152.99502249506395 97.11371602736625 151.03840024835245 97.41667634462623 149.06613207777548 97.24256766164424 147.0938639071985 97.06845897866225 145.22057813149667 96.42740050027368 143.34729235579482 95.7863420218851 141.68186443226784 94.7155920969739 140.01643650874087 93.6448421720627 138.65566118655394 92.20663283657368 137.29488586436702 90.76842350108464 136.3178514691814 89.04634354917039 135.3408170739958 87.32426359725613 134.80430889076544 85.4184003966335 134.2678007075351 83.51253719601085 134.20300061707707 81.53365960544662 134.13820052661907 79.55478201488238 134.54887471323542 77.6179024929173 134.95954889985177 75.6810229709522 135.82182896052092 73.89871304640678 136.68410902119007 72.11640312186135 136.68366487588662 72.11709393861813 Z";

export class FreehandTool extends BaseTool {
  private path: BrushPath;
  private dragging: boolean;
  private _strokeOptions: StrokeOptions;
  private _freeOptions: FreehandToolOptions;
  private texture?: RenderTexture;
  private worker: Worker;

  constructor(pixi: PixiApplication, longPressCallback?: () => void) {
    super(pixi, longPressCallback);
    this.cursor = "crosshair";

    this._strokeOptions = DEFAULT_STROKE_OPTIONS;
    this._freeOptions = { color: getRandomIntInclusive(0, 0xffffff) };
    this.path = new BrushPath();
    this.dragging = false;

    this.worker = new Worker(
      new URL("../../workers/test.worker", import.meta.url)
    );
    // this.worker.onmessage = (e) => {
    //   const faces = e.data as MultiPolygon;
    //   const { color } = this._freeOptions;

    //   this.path.clear();
    //   this.path.beginFill(ctn(color), 1);
    //   faces.forEach((face) => {
    //     face.forEach((points, j) => {
    //       // this.path.lineStyle({ width: 1, color: 0xffffff });
    //       if (j !== 0) this.path.beginHole();
    //       this.path.drawPolygon(points.flatMap((p) => p));
    //       this.path.finishPoly();
    //       if (j !== 0) this.path.endHole();
    //     });
    //   });
    //   this.path.endFill();
    // };
  }

  activate(blank = false, options?: InteractionManagerOptions | undefined) {
    super.start(false, options);

    // handle viewport listeners:

    // attach listeners:
    if (blank) return;

    this.interaction?.on("pointerdown", this.drawStart);
    this.interaction?.on("pointerup", this.drawEnd);
    this.interaction?.on("pointermove", this.storePoints);

    const debounceMove = debounce(this.drawMove, 0);
    this.interaction?.on("pointermove", debounceMove);
    // this.interaction?.on("pointermove", this.drawMove); // laggier than the debounced version
  }

  drawStart = (event: InteractionEvent) => {
    if (this.button !== 0) return;

    this.dragging = true;
    this.path = new BrushPath();
    this.pixi.items.addChild(this.path);
    const { x, y } = event.data.getLocalPosition(this.pixi.viewport);
    this.path.originalPath.push([x, y]);
  };

  storePoints = (event: InteractionEvent) => {
    if (!this.dragging || this.longPressed || this.touches > 1) return;
    const { x, y } = event.data.getLocalPosition(this.pixi.viewport);
    this.path.originalPath.push([x, y]);
  };

  drawMove = () => {
    if (!this.dragging || this.longPressed || this.touches > 1) return;
    console.log("drawMove");
    const { color } = this._freeOptions;
    const points = this.path.originalPath;
    const outlinePoints = getStroke(points, this._strokeOptions);
    // const svgPath = getSvgPathFromStroke(outlinePoints);

    try {
      const faces = union([outlinePoints as Ring]); // very expensive calculation, need to find a way to optimize this

      this.path.clear();
      this.path.beginFill(ctn(color), 1);
      faces.forEach((face) => {
        face.forEach((points, j) => {
          // this.path.lineStyle({ width: 1, color: 0xffffff });
          if (j !== 0) this.path.beginHole();
          this.path.drawPolygon(points.flatMap((p) => p));
          this.path.finishPoly();
          if (j !== 0) this.path.endHole();
        });
      });
      this.path.endFill();
    } catch (e) {
      console.error(e);
    }

    //--------------------------------------------------------------------------------
    // this.worker.postMessage(outlinePoints);
    //--------------------------------------------------------------------------------
    // if (!this.svg2 || !this.p2 || !this.svgScene) return;
    // this.svg2.firstChild?.remove();
    // this.p2.setAttributeNS("http://www.w3.org/2000/svg", "d", svgPath);
    // this.svg2.appendChild(this.p2);
    // this.svgScene.content = this.svg2;
    // this.svgScene.refresh();
    //----------------------------------------------------------------------------------
    // this.path.clear();
    // this.path.beginFill(ctn(color), 1);
    // this.path.drawPolygon(outlinePoints.flatMap((p) => p));
    // this.path.endFill();
  };

  drawEnd = () => {
    console.log("freehand:pointerup");
    this.path.interactive = true; // set path to interactive after the drawing is complete
    this.dragging = false;
  };
}

export class BrushPath extends Graphics {
  originalPath: number[][] = [];
}

export class Brush extends SVGScene {
  public refresh() {
    this.populateScene();
  }
}
